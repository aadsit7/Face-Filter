<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snapchat-Style Face Filter Web App</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  </head>
  <body class="bg-gray-50 font-[Inter] text-gray-900 min-h-screen flex flex-col">
    <div class="container mx-auto px-6 lg:px-12 py-6 flex-grow">
      <header class="mb-6">
        <h1 class="text-3xl font-semibold leading-tight">Snapchat-Style Face Filter</h1>
      </header>
      <nav class="flex mb-6 bg-white rounded-full p-1 shadow-md" role="tablist" aria-label="Tabs">
        <button class="tab-button flex-1 py-2 px-4 rounded-full text-center font-medium bg-blue-600 text-white transition-all duration-300" data-tab="upload" role="tab" aria-selected="true" aria-controls="upload-tab">Upload Image</button>
        <button class="tab-button flex-1 py-2 px-4 rounded-full text-center font-medium bg-transparent text-gray-700 hover:bg-gray-100 transition-all duration-300" data-tab="camera" role="tab" aria-selected="false" aria-controls="camera-tab">Camera Filter</button>
      </nav>
      <main>
        <section id="upload-tab" class="tab-content bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300" role="tabpanel" aria-labelledby="upload-tab-button">
          <h2 class="text-xl font-medium mb-4">Upload Filter Image</h2>
          <label for="upload-input" class="inline-block bg-blue-600 hover:bg-blue-700 text-white rounded-full px-6 py-2 shadow-sm cursor-pointer mb-4">Choose Image</label>
          <input type="file" id="upload-input" accept="image/png, image/jpeg" class="hidden">
          <img id="upload-preview" alt="Preview of uploaded image" class="max-w-full h-auto rounded-lg mb-4 hidden">
          <p id="upload-message" class="text-base text-gray-700 leading-relaxed hidden">Image uploaded! Switch to the Camera tab to apply the filter.</p>
        </section>
        <section id="camera-tab" class="tab-content hidden bg-white rounded-2xl shadow-md p-6 hover:shadow-lg transition-shadow duration-300" role="tabpanel" aria-labelledby="camera-tab-button">
          <h2 class="text-xl font-medium mb-4">Camera Filter</h2>
          <p id="no-image-message" class="text-base text-gray-700 leading-relaxed">Please upload an image in the Upload tab first.</p>
          <div id="camera-container" class="relative w-full hidden">
            <video id="video" playsinline class="hidden"></video>
            <canvas id="canvas" class="max-w-full h-auto rounded-lg"></canvas>
          </div>
          <button id="start-camera" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full px-6 py-2 shadow-sm hidden">Start Camera</button>
        </section>
      </main>
    </div>
    <script>
      lucide.createIcons();
      let uploadedImage = null;
      let video = null;
      let canvas = null;
      let isCameraRunning = false;
      let modelsLoaded = false;
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const tab = button.dataset.tab;
          tabButtons.forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-transparent', 'text-gray-700', 'hover:bg-gray-100');
            btn.setAttribute('aria-selected', 'false');
          });
          button.classList.add('bg-blue-600', 'text-white');
          button.classList.remove('bg-transparent', 'text-gray-700', 'hover:bg-gray-100');
          button.setAttribute('aria-selected', 'true');
          tabContents.forEach(content => content.classList.add('hidden'));
          document.getElementById(`${tab}-tab`).classList.remove('hidden');
          if (tab === 'camera' && uploadedImage) {
            document.getElementById('no-image-message').classList.add('hidden');
            document.getElementById('start-camera').classList.remove('hidden');
          } else if (tab === 'camera') {
            document.getElementById('no-image-message').classList.remove('hidden');
            document.getElementById('start-camera').classList.add('hidden');
            document.getElementById('camera-container').classList.add('hidden');
          }
        });
      });
      async function loadModels() {
        try {
          await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
          await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
          modelsLoaded = true;
        } catch (error) {
          console.error('Error loading models:', error);
          alert('Failed to load face detection models. Please try again later.');
        }
      }
      async function startCamera() {
        if (!modelsLoaded || !uploadedImage) return;
        video = document.getElementById('video');
        canvas = document.getElementById('canvas');
        const noImageMsg = document.getElementById('no-image-message');
        const cameraContainer = document.getElementById('camera-container');
        const startButton = document.getElementById('start-camera');
        noImageMsg.classList.add('hidden');
        startButton.classList.add('hidden');
        cameraContainer.classList.remove('hidden');
        const constraints = { video: { facingMode: 'user' } };
        try {
          const stream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = stream;
          video.setAttribute('playsinline', true);
          video.addEventListener('loadedmetadata', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            isCameraRunning = true;
            detectAndDraw();
          });
          video.play();
        } catch (error) {
          console.error('Error accessing camera:', error);
          alert('Camera access denied or unavailable. Please grant permission in your browser settings.');
        }
      }
      async function detectAndDraw() {
        if (!isCameraRunning) return;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 });
        const detections = await faceapi.detectAllFaces(video, options).withFaceLandmarks();
        if (detections.length > 0) {
          const detection = detections[0];
          const landmarks = detection.landmarks;
          const box = detection.detection.box;
          const leftEye = landmarks.getLeftEye();
          const rightEye = landmarks.getRightEye();
          const eyeCenterX = (leftEye.reduce((sum, p) => sum + p.x, 0) / leftEye.length + rightEye.reduce((sum, p) => sum + p.x, 0) / rightEye.length) / 2;
          const eyeCenterY = (leftEye.reduce((sum, p) => sum + p.y, 0) / leftEye.length + rightEye.reduce((sum, p) => sum + p.y, 0) / rightEye.length) / 2;
          const overlayWidth = box.width * 2.2;
          const overlayHeight = (uploadedImage.height / uploadedImage.width) * overlayWidth;
          const overlayX = eyeCenterX - overlayWidth / 2;
          const overlayY = eyeCenterY - overlayHeight / 2 - box.height * 0.2;
          ctx.drawImage(uploadedImage, overlayX, overlayY, overlayWidth, overlayHeight);
        }
        requestAnimationFrame(detectAndDraw);
      }
      document.getElementById('upload-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const preview = document.getElementById('upload-preview');
            preview.src = e.target.result;
            preview.classList.remove('hidden');
            uploadedImage = new Image();
            uploadedImage.src = e.target.result;
            document.getElementById('upload-message').classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
      document.getElementById('start-camera').addEventListener('click', startCamera);
      loadModels();
    </script>
  </body>
</html>
